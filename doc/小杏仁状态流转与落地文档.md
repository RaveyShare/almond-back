1. 产品目标

小杏仁是一个“想法自动演化系统”，核心目标是：

用户随手记录想法

AI 自动理解、演化、收敛

最终定性为 MEMORY / ACTION / GOAL / DECISION / REVIEW

用户可干预，但绝大部分流程由 AI 自动完成

全程可追溯、可复盘，保证每条想法历史可查

2. 核心数据模型
   2.1 almond_item（核心表）

存储用户输入和想法状态

核心字段：

content：用户原始输入

clarified_content：AI 澄清后的文本，用户可修改

title：AI 生成或用户修改的摘要

almond_status：成熟度状态（RAW / UNDERSTOOD / EVOLVING / CONVERGED / ARCHIVED）

final_type：终态类型（MEMORY / ACTION / GOAL / DECISION / REVIEW）

maturity_score：成熟度评分

evolution_stage：演化阶段

user_feedback：用户修改反馈（accept/modify/reject）

审计字段：creator / creator_id / create_time / updater / updater_id / update_time

2.2 almond_state_log（状态日志）

记录每次状态变更

核心字段：

almond_id, user_id

from_status → to_status

trigger_type（AI / USER / SYSTEM / TIME）

context_data（JSON，可存 AI 输出或用户修改）

description（可选）

create_time

2.3 almond_ai_snapshot（AI 分析快照）

存储每次 AI 分析结果

核心字段：

analysis_type：understanding / evolution_check / convergence_check

analysis_result（JSON 包含：clarified_text / title / tags / confidence / reasoning）

status / cost_time / creator / create_time

2.4 其他表

almond_tag / almond_tag_relation → 标签系统

action_execution → ACTION 类型执行

memory_aids → MEMORY 类型辅助

review / review_schedule → REVIEW 类型及复习计划

automation_log → 自动化操作记录

3. 状态流转规则
   3.1 总览
   RAW → UNDERSTOOD → EVOLVING → CONVERGED → ARCHIVED

3.2 触发条件
流转	条件	AI/用户行为
RAW → UNDERSTOOD	AI 能提取至少1条核心信息，confidence≥0.7	AI 自动生成澄清文本（clarified_content）、title、标签
UNDERSTOOD → EVOLVING	新增信息≥10%或新增标签/实体，confidence≥0.7	AI 聚合历史内容生成演化笔记；用户可强制推进
EVOLVING → CONVERGED	内容稳定变化≤10%，confidence≥0.8	AI 生成 finalType 候选集；用户可确认或修改
CONVERGED → ARCHIVED	用户确认完成或系统策略触发	状态归档，AI 不再流转
3.3 状态转换及成果
当前状态	下一个状态	产出/成果
RAW	UNDERSTOOD	clarified_content, title, tags
UNDERSTOOD	EVOLVING	演化笔记、演化阶段+1
EVOLVING	CONVERGED	finalType 确定、maturity_score 更新
CONVERGED	ARCHIVED	冻结、终态保存 finalType
4. 用户交互规则

title 生成：

AI 自动生成初版 title

用户可修改

修改写日志，标记 user_feedback = modify

finalType 确认：

仅在 CONVERGED 阶段

AI 提供推荐

用户可确认或修改

5. 审计与可追溯

每次状态变化都写入 almond_state_log

每次 AI 分析写入 almond_ai_snapshot

用户修改写入 user_feedback + 日志

ARCHIVED 为终态，不再流转

6. 第一个用例示例

用户输入：

我开发这个小杏仁来来回回推翻自己好几回。

6.1 RAW 阶段
INSERT INTO almond_item (user_id, content, almond_status, create_time)
VALUES (123, '我开发这个小杏仁来来回回推翻自己好几回。', 'RAW', NOW());


状态日志：

INSERT INTO almond_state_log (almond_id, user_id, from_status, to_status, trigger_type, context_data, create_time)
VALUES (1, 123, NULL, 'RAW', 'USER', '{"content":"我开发这个小杏仁来来回回推翻自己好几回。"}', NOW());

6.2 AI 自动分析（RAW → UNDERSTOOD）

Prompt 示例（要求固定 JSON 输出）：

你是小杏仁系统的 AI 分析引擎。
输入：
{ "user_input": "我开发这个小杏仁来来回回推翻自己好几回。" }
任务：
1. 澄清原始文本，生成 clarified_text
2. 提取标签 tags
3. 生成 title（50字以内）

返回 JSON：
{
"clarified_text": "...",
"title": "...",
"tags": ["...", "..."],
"confidence": 0-1
}


示例返回：

{
"clarified_text": "用户在小杏仁开发过程中，多次推翻自己的设计方案。",
"title": "小杏仁开发迭代记录",
"tags": ["开发","小杏仁","迭代","推翻"],
"confidence": 0.85
}


写入 AI 快照表：

INSERT INTO almond_ai_snapshot (
almond_id, user_id, analysis_type, ai_model, prompt_content, analysis_result, status, create_time
) VALUES (
1, 123, 'understanding', 'gpt-5-mini',
'{ "user_input": "我开发这个小杏仁来来回回推翻自己好几回。" }',
'{"clarified_text":"用户在小杏仁开发过程中，多次推翻自己的设计方案","title":"小杏仁开发迭代记录","tags":["开发","小杏仁","迭代","推翻"],"confidence":0.85}',
'success', NOW()
);


更新 almond_item 表：

UPDATE almond_item
SET almond_status='UNDERSTOOD',
title='小杏仁开发迭代记录',
clarified_content='用户在小杏仁开发过程中，多次推翻自己的设计方案。',
update_time=NOW()
WHERE id=1;


写入状态日志：

INSERT INTO almond_state_log (
almond_id, user_id, from_status, to_status, trigger_type, context_data, create_time
) VALUES (
1, 123, 'RAW', 'UNDERSTOOD', 'AI',
'{"clarified_text":"用户在小杏仁开发过程中，多次推翻自己的设计方案","title":"小杏仁开发迭代记录","tags":["开发","小杏仁","迭代","推翻"],"confidence":0.85}',
NOW()
);

6.3 用户干预（可选）

用户可修改 clarified_content 或 title

状态保持 UNDERSTOOD，写日志标记 trigger_type=USER，user_feedback=modify

UPDATE almond_item
SET clarified_content='用户在小杏仁开发过程中多次修改设计方案。',
title='小杏仁开发多次迭代',
update_time=NOW()
WHERE id=1;

INSERT INTO almond_state_log (
almond_id, user_id, from_status, to_status, trigger_type, context_data, create_time
) VALUES (
1, 123, 'UNDERSTOOD', 'UNDERSTOOD', 'USER',
'{"old_clarified":"用户在小杏仁开发过程中，多次推翻自己的设计方案","new_clarified":"用户在小杏仁开发过程中多次修改设计方案","old_title":"小杏仁开发迭代记录","new_title":"小杏仁开发多次迭代"}',
NOW()
);

✅ 结果

almond_status = UNDERSTOOD

content 保留原始用户输入

clarified_content 为 AI 生成或用户修改的澄清文本

title 为 AI 生成或用户修改

AI 分析快照、状态日志完整

用户可继续流转到 EVOLVING